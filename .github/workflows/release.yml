name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Install Apple Certificate
      env:
        BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
        CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # Skip if certificate secrets are not configured
        if [ -z "$BUILD_CERTIFICATE_BASE64" ]; then
          echo "âš ï¸  Code signing certificates not configured - building unsigned"
          echo "   To enable code signing, add BUILD_CERTIFICATE_BASE64, CERTIFICATE_PASSWORD,"
          echo "   and KEYCHAIN_PASSWORD to your repository secrets"
          exit 0
        fi

        # Create variables
        CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

        # Import certificate from secrets
        echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

        # Create temporary keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # Import certificate to keychain
        security import $CERTIFICATE_PATH -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH

        # Enable codesigning from a non user interactive shell
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

    - name: Build ScreenDay Release
      env:
        BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        # Build with or without code signing based on certificate availability
        if [ -z "$BUILD_CERTIFICATE_BASE64" ]; then
          echo "ðŸ“¦ Building unsigned release..."
          xcodebuild clean build \
            -project ScreenDay/ScreenDay.xcodeproj \
            -scheme ScreenDay \
            -configuration Release \
            -derivedDataPath DerivedData \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM=""
        else
          echo "ðŸ“¦ Building signed release..."
          xcodebuild clean build \
            -project ScreenDay/ScreenDay.xcodeproj \
            -scheme ScreenDay \
            -configuration Release \
            -derivedDataPath DerivedData \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            OTHER_CODE_SIGN_FLAGS="--timestamp" \
            CODE_SIGN_INJECT_BASE_ENTITLEMENTS=NO
        fi

    - name: Verify code signature
      env:
        BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
      run: |
        if [ -z "$BUILD_CERTIFICATE_BASE64" ]; then
          echo "âš ï¸  Skipping signature verification (unsigned build)"
          exit 0
        fi
        
        APP_PATH="DerivedData/Build/Products/Release/ScreenDay.app"
        
        echo "ðŸ” Verifying code signature..."
        codesign -vvv --deep --strict "$APP_PATH"
        
        echo ""
        echo "ðŸ“‹ Code signature details:"
        codesign -dv --verbose=4 "$APP_PATH" 2>&1
        
        echo ""
        echo "ðŸ” Entitlements:"
        codesign -d --entitlements - "$APP_PATH"

    - name: Notarize app (optional)
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        if [ -z "$APPLE_ID" ]; then
          echo "âš ï¸  Notarization not configured - skipping"
          echo "   To enable notarization, add APPLE_ID, APPLE_ID_PASSWORD,"
          echo "   and APPLE_TEAM_ID to your repository secrets"
          exit 0
        fi

        echo "ðŸ“ Notarizing app..."
        APP_PATH="DerivedData/Build/Products/Release/ScreenDay.app"

        # Create a zip for notarization
        ditto -c -k --keepParent "$APP_PATH" "$APP_PATH.zip"

        # Submit for notarization and capture the submission ID
        SUBMIT_OUTPUT=$(xcrun notarytool submit "$APP_PATH.zip" \
          --apple-id "$APPLE_ID" \
          --password "$APPLE_ID_PASSWORD" \
          --team-id "$APPLE_TEAM_ID" \
          --wait 2>&1) || true
        
        echo "$SUBMIT_OUTPUT"
        
        # Extract submission ID from output
        SUBMISSION_ID=$(echo "$SUBMIT_OUTPUT" | grep "id:" | head -1 | awk '{print $2}')
        
        # Check if notarization succeeded
        if echo "$SUBMIT_OUTPUT" | grep -q "status: Accepted"; then
          echo "âœ… Notarization accepted"
          # Staple the notarization ticket
          xcrun stapler staple "$APP_PATH"
          echo "âœ… Notarization complete"
        else
          echo "âŒ Notarization failed"
          echo ""
          echo "ðŸ“‹ Fetching detailed log from Apple..."
          if [ -n "$SUBMISSION_ID" ]; then
            xcrun notarytool log "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_ID_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              notarization-log.json || true
            echo ""
            echo "=== NOTARIZATION LOG ==="
            cat notarization-log.json
            echo "========================"
          fi
          exit 1
        fi

    - name: Create app bundle
      run: |
        cd DerivedData/Build/Products/Release
        zip -r ScreenDay.app.zip ScreenDay.app

    - name: Clean up keychain
      if: always()
      run: |
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        if [ -f "$KEYCHAIN_PATH" ]; then
          security delete-keychain $KEYCHAIN_PATH || true
        fi

    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: ScreenDay ${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        body: |
          Release ${{ steps.get_version.outputs.VERSION }}

          ## Installation
          1. Download ScreenDay.app.zip
          2. Unzip the file
          3. Move ScreenDay.app to your Applications folder
          4. Right-click and select "Open" on first launch (macOS will ask for confirmation)

          ## What's New
          - See commit history for changes in this release

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./DerivedData/Build/Products/Release/ScreenDay.app.zip
        asset_name: ScreenDay.app.zip
        asset_content_type: application/zip
